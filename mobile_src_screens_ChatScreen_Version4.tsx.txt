import React, { useEffect, useState, useRef } from "react";
import { View, Text, FlatList, TextInput, Button, StyleSheet, SafeAreaView, TouchableOpacity } from "react-native";
import { fetchMessages, uploadMedia } from "../services/api";
import { getSocket, connectSocket } from "../services/socket";
import * as DocumentPicker from "expo-document-picker";
import * as FileSystem from "expo-file-system";
import { Audio } from "expo-av";

export default function ChatScreen({ route }: any) {
  const { channel } = route.params;
  const [messages, setMessages] = useState<any[]>([]);
  const [text, setText] = useState("");
  const socketRef = useRef<any>(null);

  useEffect(() => {
    async function init() {
      const data = await fetchMessages(channel.id);
      setMessages(data);
      const s = getSocket() || connectSocket();
      socketRef.current = s;

      s.emit("joinChannel", channel.id);

      s.on("message:created", (msg: any) => {
        if (msg.channelId === channel.id) {
          setMessages((m) => [...m, msg]);
        }
      });

      s.on("presence:update", (p: any) => {
        // optionally show participants
      });
    }
    init();

    return () => {
      const s = socketRef.current;
      if (s) {
        s.emit("leaveChannel", channel.id);
        s.off("message:created");
        s.off("presence:update");
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const sendMessage = () => {
    const s = socketRef.current;
    if (!s) return;
    s.emit("message:new", { channelId: channel.id, body: text });
    setText("");
  };

  const pickFileAndUpload = async () => {
    const res = await DocumentPicker.getDocumentAsync({});
    if (res.type === "success") {
      // upload file
      const uploadRes = await uploadMedia(res.uri, res.name);
      const s = socketRef.current;
      s.emit("message:new", { channelId: channel.id, mediaUrl: uploadRes.url });
    }
  };

  // Simple voice recording flow
  const [recording, setRecording] = useState<Audio.Recording | null>(null);

  async function startRecording() {
    try {
      await Audio.requestPermissionsAsync();
      await Audio.setAudioModeAsync({ allowsRecordingIOS: true, playsInSilentModeIOS: true });
      const rec = new Audio.Recording();
      await rec.prepareToRecordAsync(Audio.RECORDING_OPTIONS_PRESET_HIGH_QUALITY);
      await rec.startAsync();
      setRecording(rec);
    } catch (err) {
      console.error("Failed to start recording", err);
    }
  }

  async function stopRecordingAndUpload() {
    try {
      if (!recording) return;
      await recording.stopAndUnloadAsync();
      const uri = recording.getURI();
      setRecording(null);
      if (uri) {
        // upload
        const filename = `voice-${Date.now()}.m4a`;
        const res = await uploadMedia(uri, filename);
        const s = socketRef.current;
        s.emit("message:new", { channelId: channel.id, mediaUrl: res.url });
      }
    } catch (err) {
      console.error(err);
    }
  }

  return (
    <SafeAreaView style={{ flex: 1 }}>
      <View style={{ padding: 12, borderBottomWidth: 1, borderColor: "#eee" }}>
        <Text style={{ fontSize: 18 }}>{channel.name}</Text>
      </View>
      <FlatList
        style={{ flex: 1 }}
        data={messages}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <View style={styles.msgRow}>
            <Text style={{ fontWeight: "bold" }}>{item.sender?.name || "unknown"}</Text>
            {item.body ? <Text>{item.body}</Text> : null}
            {item.mediaUrl ? <Text style={{ color: "blue" }}>{item.mediaUrl}</Text> : null}
          </View>
        )}
      />
      <View style={{ padding: 8, borderTopWidth: 1, borderColor: "#eee" }}>
        <View style={{ flexDirection: "row", alignItems: "center" }}>
          <TextInput style={styles.input} placeholder="Message..." value={text} onChangeText={setText} />
          <Button title="Send" onPress={sendMessage} />
        </View>
        <View style={{ flexDirection: "row", marginTop: 8 }}>
          <Button title="Attach" onPress={pickFileAndUpload} />
          <View style={{ width: 12 }} />
          {!recording ? (
            <Button title="Record" onPress={startRecording} />
          ) : (
            <Button title="Stop & Upload" onPress={stopRecordingAndUpload} />
          )}
        </View>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  msgRow: { padding: 12, borderBottomWidth: 1, borderColor: "#f1f1f1" },
  input: { flex: 1, borderWidth: 1, borderColor: "#ddd", padding: 8, marginRight: 8 },
});