import React, { useEffect, useState } from "react";
import { View, Text, Button, FlatList, TouchableOpacity, StyleSheet, SafeAreaView, TextInput } from "react-native";
import { getChannels, createChannel } from "../services/api";
import { connectSocket, getSocket } from "../services/socket";

export default function ChannelsScreen({ navigation }: any) {
  const [channels, setChannels] = useState<any[]>([]);
  const [name, setName] = useState("");

  async function load() {
    const ch = await getChannels();
    setChannels(ch);
  }

  useEffect(() => {
    load();
    const s = getSocket() || connectSocket();
    // presence updates could be handled here
    s.on("connect", () => {});
    return () => {
      s.off("connect");
    };
  }, []);

  async function addChannel() {
    if (!name) return;
    await createChannel(name);
    setName("");
    load();
  }

  return (
    <SafeAreaView style={{ flex: 1 }}>
      <View style={{ padding: 16 }}>
        <Text style={{ fontSize: 20, marginBottom: 12 }}>Channels</Text>
        <FlatList
          data={channels}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => (
            <TouchableOpacity onPress={() => navigation.navigate("Chat", { channel: item })} style={styles.channel}>
              <Text style={{ fontSize: 16 }}>{item.name}</Text>
            </TouchableOpacity>
          )}
        />
        <View style={{ flexDirection: "row", marginTop: 12 }}>
          <TextInput style={styles.input} placeholder="Channel name" value={name} onChangeText={setName} />
          <Button title="Create" onPress={addChannel} />
        </View>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  channel: { padding: 12, borderBottomWidth: 1, borderColor: "#eee" },
  input: { flex: 1, borderWidth: 1, borderColor: "#ddd", padding: 8, marginRight: 8 },
});